id: push_to_github
namespace: zoomcamp
description: |
  The CSV Data used in the course: https://github.com/DataTalksClub/nyc-tlc-data/releases

variables:
  gh_username: mnaufalazwar
  gh_repo: https://github.com/mnaufalazwar/kestra-zoomcamp-flows-tutorial

tasks:
  - id: push_flows
    type: io.kestra.plugin.git.PushFlows
    sourceNamespace: zoomcamp
    targetNamespace: zoomcamp
    flows:
      - 02_postgres_taxi
      - 02_postgres_taxi_scheduled
      - 03_postgres_dbt
      - 04_gcp_kv
      - 05_gcp_setup
      - 06_gcp_taxi
      - 06_gcp_taxi_scheduled
      - 06_gcp_fhv_scheduled
      - 07_gcp_dbt
      - 08_kv_github
      - push_to_github
      - say_hi
    includeChildNamespaces: true
    gitDirectory: _flows
    url: "{{ vars.gh_repo }}"
    username: "{{ vars.gh_username }}"
    password: "{{secret('GITHUB_ACCESS_TOKEN')}}"
    branch: develop
    commitMessage: add flows {{ now() }}

  - id: push_namespace_files
    type: io.kestra.plugin.git.PushNamespaceFiles
    namespace: zoomcamp               # from sourceNamespace in push_flows
    files:                            # or list of specific files if needed
      - "**/*"  
    gitDirectory: _files              # folder in GitHub repo for namespace files
    url: "{{ vars.gh_repo }}"
    username: "{{ vars.gh_username }}"
    password: "{{ secret('GITHUB_ACCESS_TOKEN') }}"
    branch: develop
    commitMessage: "add namespace files {{ now() }}"

  - id: push_flows_company
    type: io.kestra.plugin.git.PushFlows
    sourceNamespace: company.team
    targetNamespace: company.team
    flows:
      - say_hi
    includeChildNamespaces: true
    gitDirectory: _flows_example
    url: "{{ vars.gh_repo }}"
    username: "{{ vars.gh_username }}"
    password: "{{secret('GITHUB_ACCESS_TOKEN')}}"
    branch: develop
    commitMessage: add flows {{ now() }}

  - id: create_pr
    type: io.kestra.plugin.github.pulls.Create
    oauthToken: "{{ secret('GITHUB_ACCESS_TOKEN') }}"
    repository: mnaufalazwar/kestra-zoomcamp-flows-tutorial
    sourceBranch: develop
    targetBranch: main
    title: Merge develop to main
    body: "Request to merge changes from develop into main"